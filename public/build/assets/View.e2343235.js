var ge=Object.defineProperty;var Q=Object.getOwnPropertySymbols;var he=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var Z=(x,m,n)=>m in x?ge(x,m,{enumerable:!0,configurable:!0,writable:!0,value:n}):x[m]=n,H=(x,m)=>{for(var n in m||(m={}))he.call(m,n)&&Z(x,n,m[n]);if(Q)for(var n of Q(m))be.call(m,n)&&Z(x,n,m[n]);return x};import{J as xe,B,G as Ie,a0 as Be,k as L,C as ke,D as we,a as O,A as Se,r as v,o as p,e as R,f as l,l as g,w as c,h as y,u,i as P,t as h,j as b,F as ee,y as Te,m as Ae,I as Ce}from"./vendor.d9c52bb1.js";import{c as Pe,i as Ne,e as Ee,j as De,b as $e,m as Fe,u as Le,g as V}from"./main.49e7919b.js";import{u as Re}from"./payment.2caafd81.js";import{_ as Ve}from"./SendInvoiceModal.37e2a00b.js";import{_ as Ue}from"./InvoiceIndexDropdown.9dbe7ffe.js";import{L as je}from"./LoadingIcon.1722c865.js";import"./mail-driver.1338ead6.js";function Me(){return{copyTextToClipboard:m=>{if(navigator.clipboard&&window.isSecureContext)return navigator.clipboard.writeText(m);{const n=document.createElement("textarea");n.value=m,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{return document.execCommand("copy"),n.remove(),Promise.resolve()}catch(w){return n.remove(),Promise.reject(w)}}}}}const ze={class:"text-sm mr-3"},Ge={class:"fixed top-0 left-0 hidden h-full pt-16 pb-[6.4rem] ml-56 bg-white xl:ml-64 w-88 xl:block"},Ye={class:"flex items-center justify-between px-4 pt-8 pb-2 border border-gray-200 border-solid height-full"},He={class:"mb-6"},Oe={class:"flex mb-6 ml-3",role:"group","aria-label":"First group"},qe={class:"px-2 py-1 pb-2 mb-1 mb-2 text-sm border-b border-gray-200 border-solid"},Ke={class:"flex-2"},Xe={class:"mt-1 mb-2 text-xs not-italic font-medium leading-5 text-gray-600"},Je={class:"flex-1 whitespace-nowrap right"},We={class:"text-sm not-italic font-normal leading-5 text-right text-gray-600 est-date"},Qe={key:0,class:"flex justify-center p-4 items-center"},Ze={key:1,class:"flex justify-center px-4 mt-5 text-sm text-gray-600"},et={class:"flex flex-col min-h-0 mt-8 overflow-hidden",style:{height:"75vh"}},tt=["src"],ut={setup(x){const m=Pe(),n=Ne(),w=Ee(),z=De(),q=Re();$e();const te=Me();Fe();const _=Le(),{t:o}=xe(),t=B(null),N=Ie(),U=B(!1),E=B(!1),K=B(""),D=B(""),f=B(null),$=B(1),G=B(1),X=B(null),r=Be({orderBy:null,orderByField:null,searchText:null}),ae=L(()=>t.value.invoice_number),J=L(()=>r.orderBy==="asc"||r.orderBy==null);L(()=>J.value?o("general.ascending"):o("general.descending"));const oe=L(()=>`/invoices/pdf/${t.value.unique_hash}`);L(()=>t.value&&t.value.id?t.value.id:null),ke(N,(e,a)=>{e.name==="invoices.view"&&j()}),we(async()=>{try{const e=await O.get("/api/v1/payment-config");K.value=e.data.domain,D.value=e.data.apiKey}catch(e){console.error("Failed to fetch payment configuration:",e)}});async function ne(){z.openDialog({title:o("general.are_you_sure"),message:o("invoices.invoice_mark_as_sent"),yesLabel:o("general.ok"),noLabel:o("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(async e=>{U.value=!1,e&&(await n.markAsSent({id:t.value.id,status:"SENT"}),t.value.status="SENT",U.value=!0),U.value=!1})}async function se(e){m.openModal({title:o("invoices.send_invoice"),componentName:"SendInvoiceModal",id:t.value.id,data:t.value})}async function re(){z.openDialog({title:o("general.are_you_sure"),message:o("invoices.pay_as_cash_confirmation"),yesLabel:o("general.ok"),noLabel:o("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(async e=>{if(e)try{console.log("Getting next payment number...");const a=await q.getNextNumber({userId:t.value.customer_id,model_id:t.value.id},!0);console.log("Next payment number response:",a);const s={customer_id:t.value.customer_id,invoice_id:t.value.id,amount:t.value.total,payment_date:Ce().format("YYYY-MM-DD"),payment_method_id:1,notes:o("invoices.paid_as_cash"),payment_number:a.data.nextNumber,company_id:t.value.company_id};console.log("Payment data being sent:",s),await q.addPayment(s),await j(),_.showNotification({type:"success",message:o("invoices.payment_created_successfully")})}catch(a){console.error("Error in onPayAsCash:",a),_.showNotification({type:"error",message:o("invoices.failed_to_create_payment")})}})}async function ie(){z.openDialog({title:o("general.are_you_sure"),message:o("invoices.generate_payment_link_confirmation"),yesLabel:o("general.ok"),noLabel:o("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(async e=>{if(e)try{console.log("Starting payment link generation process...");const a="/api/v1/payment-intent";console.log("Calling Payment Intent API:",{url:a,body:{id:0,uniqueId:null,contextId:`invoice # ${t.value.invoice_number}`,amount:t.value.total/100,total:t.value.total/100,currency:t.value.currency.code,tax:t.value.tax/100,description:`Payment for invoice ${t.value.invoice_number}`,result:"",message:"",userId:t.value.customer.email,context:"order",tenantId:1001,status:"CREATED",currencySymbol:t.value.currency.symbol}});const s=await O.post(a,{id:0,uniqueId:null,contextId:`invoice # ${t.value.invoice_number}`,amount:t.value.total/100,total:t.value.total/100,currency:t.value.currency.code,tax:t.value.tax/100,description:`Payment for invoice ${t.value.invoice_number}`,result:"",message:"",userId:t.value.customer.email,context:"order",tenantId:1001,status:"CREATED",currencySymbol:t.value.currency.symbol});if(console.log("Payment Intent API Response:",{status:s.status,data:s.data}),s.status===200||s.status===201){const I=s.data;if(console.log("Received UUID from Payment Intent API:",I),!I){console.error("No UUID received from Payment Intent API"),_.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")});return}const S=`/api/v1/challenge-code?uuid=${I}&src=email`;console.log("Calling Challenge Code API:",{url:S,headers:{Authorization:`Bearer ${D.value}`,"X-apikey":D.value}});const d=await O.get(S,{headers:{Authorization:`Bearer ${D.value}`,"X-apikey":D.value}});if(console.log("Challenge Code API Response:",{status:d.status,data:d.data}),d.status===200||d.status===201){if(!d.data){console.error("Empty response from Challenge Code API"),_.showNotification({type:"error",message:o("invoices.invalid_payment_link_response")});return}const M=d.data.url||null;if(!M){console.error("URL not found in Challenge Code API response:",d.data),_.showNotification({type:"error",message:o("invoices.invalid_payment_link_response")});return}const T=`${K.value}${M.replace("null?","pay.ps?")}`;console.log("Generated Payment Link:",T);const C={fields:[{name:"PaymentLink",value:T}]};console.log("Updating invoice with payment link:",{invoiceId:t.value.id,customFieldData:C});try{const A=await n.updateInvoice({id:t.value.id,customFields:C});console.log("Invoice Update Response:",{status:"success",data:A}),te.copyTextToClipboard(T),_.showNotification({type:"success",message:o("invoices.payment_link_copied")}),console.log("Refreshing invoice data..."),await j(),console.log("Invoice data refreshed successfully")}catch(A){console.error("Failed to update invoice:",A),_.showNotification({type:"error",message:o("invoices.failed_to_update_payment_link")})}}else console.error("Challenge Code API failed:",{status:d.status,data:d.data}),_.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")})}else console.error("Payment Intent API failed:",{status:s.status,data:s.data}),_.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")})}catch(a){console.error("Error in onGeneratePaymentLink:",{error:a,message:a.message,response:a.response?{status:a.response.status,data:a.response.data}:null}),_.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")})}})}function le(e){return N.params.id==e}async function F(e,a=!1){if(E.value)return;let s={};r.searchText!==""&&r.searchText!==null&&r.searchText!==void 0&&(s.search=r.searchText),r.orderBy!==null&&r.orderBy!==void 0&&(s.orderBy=r.orderBy),r.orderByField!==null&&r.orderByField!==void 0&&(s.orderByField=r.orderByField),E.value=!0;let I=await n.fetchInvoices(H({page:e},s));E.value=!1,f.value=f.value?f.value:[],f.value=[...f.value,...I.data.data],$.value=e||1,G.value=I.data.meta.last_page;let S=f.value.find(d=>d.id==N.params.id);a==!1&&!S&&$.value<G.value&&Object.keys(s).length===0&&F(++$.value),S&&setTimeout(()=>{a==!1&&ce()},500)}function ce(){const e=document.getElementById(`invoice-${N.params.id}`);e&&(e.scrollIntoView({behavior:"smooth"}),e.classList.add("shake"),ue())}function ue(){X.value.addEventListener("scroll",e=>{e.target.scrollTop>0&&e.target.scrollTop+e.target.clientHeight>e.target.scrollHeight-200&&$.value<G.value&&F(++$.value,!0)})}async function j(){let e=await n.fetchInvoice(N.params.id);e.data&&(t.value=H({},e.data.data))}async function k(){f.value=[],F()}function de(){return r.orderBy==="asc"?(r.orderBy="desc",k(),!0):(r.orderBy="asc",k(),!0)}function me(){let e=f.value.findIndex(a=>a.id===t.value.id);f.value[e]&&(f.value[e].status="SENT",t.value.status="SENT")}return F(),j(),k=Se.exports.debounce(k,500),(e,a)=>{const s=v("BaseButton"),I=v("router-link"),S=v("BasePageHeader"),d=v("BaseIcon"),M=v("BaseInput"),T=v("BaseRadio"),C=v("BaseInputGroup"),A=v("BaseDropdownItem"),pe=v("BaseDropdown"),ve=v("BaseText"),ye=v("BaseEstimateStatusBadge"),fe=v("BaseFormatMoney"),_e=v("BasePage");return p(),R(ee,null,[l(Ve,{onUpdate:me}),t.value?(p(),g(_e,{key:0,class:"xl:pl-96 xl:ml-8"},{default:c(()=>{var W;return[l(S,{title:u(ae)},{actions:c(()=>[y("div",ze,[t.value.status==="DRAFT"&&u(w).hasAbilities(u(V).EDIT_INVOICE)?(p(),g(s,{key:0,disabled:U.value,variant:"primary-outline",onClick:ne},{default:c(()=>[P(h(e.$t("invoices.mark_as_sent")),1)]),_:1},8,["disabled"])):b("",!0)]),t.value.status==="DRAFT"&&u(w).hasAbilities(u(V).SEND_INVOICE)?(p(),g(s,{key:0,variant:"primary",class:"text-sm mr-2",onClick:se},{default:c(()=>[P(h(e.$t("invoices.send_invoice")),1)]),_:1})):b("",!0),t.value.status==="DRAFT"&&u(w).hasAbilities(u(V).CREATE_PAYMENT)?(p(),g(s,{key:1,variant:"primary",class:"text-sm",onClick:re},{default:c(()=>[P(h(e.$t("invoices.pay_as_cash")),1)]),_:1})):b("",!0),t.value.status==="DRAFT"&&u(w).hasAbilities(u(V).CREATE_PAYMENT)?(p(),g(s,{key:2,variant:"primary",class:"text-sm ml-2",onClick:ie},{default:c(()=>[P(h(e.$t("invoices.generate_payment_link")),1)]),_:1})):b("",!0),u(w).hasAbilities(u(V).CREATE_PAYMENT)?(p(),g(I,{key:3,to:`/admin/payments/${e.$route.params.id}/create`},{default:c(()=>[t.value.status==="SENT"||t.value.status==="VIEWED"?(p(),g(s,{key:0,variant:"primary"},{default:c(()=>[P(h(e.$t("invoices.record_payment")),1)]),_:1})):b("",!0)]),_:1},8,["to"])):b("",!0),l(Ue,{class:"ml-3",row:t.value,"load-data":F},null,8,["row"])]),_:1},8,["title"]),y("div",Ge,[y("div",Ye,[y("div",He,[l(M,{modelValue:u(r).searchText,"onUpdate:modelValue":a[0]||(a[0]=i=>u(r).searchText=i),placeholder:e.$t("general.search"),type:"text",variant:"gray",onInput:a[1]||(a[1]=i=>k())},{right:c(()=>[l(d,{name:"SearchIcon",class:"h-5 text-gray-400"})]),_:1},8,["modelValue","placeholder"])]),y("div",Oe,[l(pe,{class:"ml-3",position:"bottom-start"},{activator:c(()=>[l(s,{size:"md",variant:"gray"},{default:c(()=>[l(d,{name:"FilterIcon"})]),_:1})]),default:c(()=>[y("div",qe,h(e.$t("general.sort_by")),1),l(A,{class:"flex px-1 py-2 cursor-pointer"},{default:c(()=>[l(C,{class:"-mt-3 font-normal"},{default:c(()=>[l(T,{id:"filter_invoice_date",modelValue:u(r).orderByField,"onUpdate:modelValue":[a[2]||(a[2]=i=>u(r).orderByField=i),k],label:e.$t("reports.invoices.invoice_date"),size:"sm",name:"filter",value:"invoice_date"},null,8,["modelValue","label"])]),_:1})]),_:1}),l(A,{class:"flex px-1 py-2 cursor-pointer"},{default:c(()=>[l(C,{class:"-mt-3 font-normal"},{default:c(()=>[l(T,{id:"filter_due_date",modelValue:u(r).orderByField,"onUpdate:modelValue":[a[3]||(a[3]=i=>u(r).orderByField=i),k],label:e.$t("invoices.due_date"),value:"due_date",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1}),l(A,{class:"flex px-1 py-2 cursor-pointer"},{default:c(()=>[l(C,{class:"-mt-3 font-normal"},{default:c(()=>[l(T,{id:"filter_invoice_number",modelValue:u(r).orderByField,"onUpdate:modelValue":[a[4]||(a[4]=i=>u(r).orderByField=i),k],label:e.$t("invoices.invoice_number"),value:"invoice_number",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1})]),_:1}),l(s,{class:"ml-1",size:"md",variant:"gray",onClick:de},{default:c(()=>[u(J)?(p(),g(d,{key:0,name:"SortAscendingIcon"})):(p(),g(d,{key:1,name:"SortDescendingIcon"}))]),_:1})])]),y("div",{ref:(i,Y)=>{Y.invoiceListSection=i,X.value=i},class:"h-full overflow-y-scroll border-l border-gray-200 border-solid base-scroll"},[(p(!0),R(ee,null,Te(f.value,(i,Y)=>(p(),R("div",{key:Y},[i?(p(),g(I,{key:0,id:"invoice-"+i.id,to:`/admin/invoices/${i.id}/view`,class:Ae(["flex justify-between side-invoice p-4 cursor-pointer hover:bg-gray-100 items-center border-l-4 border-transparent",{"bg-gray-100 border-l-4 border-primary-500 border-solid":le(i.id)}]),style:{"border-bottom":"1px solid rgba(185, 193, 209, 0.41)"}},{default:c(()=>[y("div",Ke,[l(ve,{text:i.customer.name,length:30,class:"pr-2 mb-2 text-sm not-italic font-normal leading-5 text-black capitalize truncate"},null,8,["text"]),y("div",Xe,h(i.invoice_number),1),l(ye,{status:i.status,class:"px-1 text-xs"},{default:c(()=>[P(h(i.status),1)]),_:2},1032,["status"])]),y("div",Je,[l(fe,{class:"mb-2 text-xl not-italic font-semibold leading-8 text-right text-gray-900 block",amount:i.total,currency:i.customer.currency},null,8,["amount","currency"]),y("div",We,h(i.formatted_invoice_date),1)])]),_:2},1032,["id","to","class"])):b("",!0)]))),128)),E.value?(p(),R("div",Qe,[l(je,{class:"h-6 m-1 animate-spin text-primary-400"})])):b("",!0),!((W=f.value)==null?void 0:W.length)&&!E.value?(p(),R("p",Ze,h(e.$t("invoices.no_matching_invoices")),1)):b("",!0)],512)]),y("div",et,[y("iframe",{src:`${u(oe)}`,class:"flex-1 border border-gray-400 border-solid bg-white rounded-md frame-style"},null,8,tt)])]}),_:1})):b("",!0)],64)}}};export{ut as default};
