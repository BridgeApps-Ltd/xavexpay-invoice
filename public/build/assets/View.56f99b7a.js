var ge=Object.defineProperty;var ee=Object.getOwnPropertySymbols;var he=Object.prototype.hasOwnProperty,be=Object.prototype.propertyIsEnumerable;var te=(I,m,n)=>m in I?ge(I,m,{enumerable:!0,configurable:!0,writable:!0,value:n}):I[m]=n,K=(I,m)=>{for(var n in m||(m={}))he.call(m,n)&&te(I,n,m[n]);if(ee)for(var n of ee(m))be.call(m,n)&&te(I,n,m[n]);return I};import{J as xe,B,G as Ie,a0 as ke,k as $,C as Be,D as we,a as G,A as Pe,r as v,o as p,e as L,f as l,l as h,w as c,h as y,u,i as A,t as b,j as x,F as ae,y as Se,m as Te,I as Ae}from"./vendor.d9c52bb1.js";import{c as Ce,i as Ne,e as Ee,j as De,b as Fe,m as $e,u as Le,g as R}from"./main.92a7e0a0.js";import{u as Re}from"./payment.47493e75.js";import{_ as Ve}from"./SendInvoiceModal.0e47c2f1.js";import{_ as Ue}from"./InvoiceIndexDropdown.540536c8.js";import{L as je}from"./LoadingIcon.e0e3077b.js";import"./mail-driver.5c26a798.js";function Me(){return{copyTextToClipboard:m=>{if(navigator.clipboard&&window.isSecureContext)return navigator.clipboard.writeText(m);{const n=document.createElement("textarea");n.value=m,n.style.position="fixed",n.style.left="-999999px",n.style.top="-999999px",document.body.appendChild(n),n.focus(),n.select();try{return document.execCommand("copy"),n.remove(),Promise.resolve()}catch(P){return n.remove(),Promise.reject(P)}}}}}const ze={class:"text-sm mr-3"},Ge={class:"fixed top-0 left-0 hidden h-full pt-16 pb-[6.4rem] ml-56 bg-white xl:ml-64 w-88 xl:block"},Ye={class:"flex items-center justify-between px-4 pt-8 pb-2 border border-gray-200 border-solid height-full"},He={class:"mb-6"},Oe={class:"flex mb-6 ml-3",role:"group","aria-label":"First group"},qe={class:"px-2 py-1 pb-2 mb-1 mb-2 text-sm border-b border-gray-200 border-solid"},Ke={class:"flex-2"},Xe={class:"mt-1 mb-2 text-xs not-italic font-medium leading-5 text-gray-600"},Je={class:"flex-1 whitespace-nowrap right"},We={class:"text-sm not-italic font-normal leading-5 text-right text-gray-600 est-date"},Qe={key:0,class:"flex justify-center p-4 items-center"},Ze={key:1,class:"flex justify-center px-4 mt-5 text-sm text-gray-600"},et={class:"flex flex-col min-h-0 mt-8 overflow-hidden",style:{height:"75vh"}},tt=["src"],ut={setup(I){const m=Ce(),n=Ne(),P=Ee(),Y=De(),X=Re();Fe();const oe=Me();$e();const f=Le(),{t:o}=xe(),e=B(null),C=Ie(),V=B(!1),N=B(!1),J=B(""),E=B(""),_=B(null),D=B(1),H=B(1),W=B(null),i=ke({orderBy:null,orderByField:null,searchText:null}),ne=$(()=>e.value.invoice_number),Q=$(()=>i.orderBy==="asc"||i.orderBy==null);$(()=>Q.value?o("general.ascending"):o("general.descending"));const se=$(()=>`/invoices/pdf/${e.value.unique_hash}`);$(()=>e.value&&e.value.id?e.value.id:null),Be(C,(t,a)=>{t.name==="invoices.view"&&U()}),we(async()=>{try{const t=await G.get("/api/v1/payment-config");J.value=t.data.domain,E.value=t.data.apiKey}catch(t){console.error("Failed to fetch payment configuration:",t)}});async function ie(){Y.openDialog({title:o("general.are_you_sure"),message:o("invoices.invoice_mark_as_sent"),yesLabel:o("general.ok"),noLabel:o("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(async t=>{V.value=!1,t&&(await n.markAsSent({id:e.value.id,status:"SENT"}),e.value.status="SENT",V.value=!0),V.value=!1})}async function re(t){m.openModal({title:o("invoices.send_invoice"),componentName:"SendInvoiceModal",id:e.value.id,data:e.value})}async function le(){Y.openDialog({title:o("general.are_you_sure"),message:o("invoices.pay_as_cash_confirmation"),yesLabel:o("general.ok"),noLabel:o("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(async t=>{if(t)try{console.log("Getting next payment number...");const a=await X.getNextNumber({userId:e.value.customer_id,model_id:e.value.id},!0);console.log("Next payment number response:",a);const s={customer_id:e.value.customer_id,invoice_id:e.value.id,amount:e.value.total,payment_date:Ae().format("YYYY-MM-DD"),payment_method_id:1,notes:o("invoices.paid_as_cash"),payment_number:a.data.nextNumber,company_id:e.value.company_id};console.log("Payment data being sent:",s),await X.addPayment(s),await U(),f.showNotification({type:"success",message:o("invoices.payment_created_successfully")})}catch(a){console.error("Error in onPayAsCash:",a),f.showNotification({type:"error",message:o("invoices.failed_to_create_payment")})}})}async function ce(){Y.openDialog({title:o("general.are_you_sure"),message:o("invoices.generate_payment_link_confirmation"),yesLabel:o("general.ok"),noLabel:o("general.cancel"),variant:"primary",hideNoButton:!1,size:"lg"}).then(async t=>{if(t)try{console.log("Starting payment link generation process...");const a="/api/v1/payment-intent";console.log("Calling Payment Intent API:",{url:a,body:{id:0,uniqueId:null,contextId:`invoice # ${e.value.invoice_number}`,amount:e.value.total/100,total:e.value.total/100,currency:e.value.currency.code,tax:e.value.tax/100,description:`Payment for invoice ${e.value.invoice_number}`,result:"",message:"",userId:e.value.customer.email,context:"order",tenantId:1001,status:"CREATED",currencySymbol:e.value.currency.symbol}});const s=await G.post(a,{id:0,uniqueId:null,contextId:`invoice # ${e.value.invoice_number}`,amount:e.value.total/100,total:e.value.total/100,currency:e.value.currency.code,tax:e.value.tax/100,description:`Payment for invoice ${e.value.invoice_number}`,result:"",message:"",userId:e.value.customer.email,context:"order",tenantId:1001,status:"CREATED",currencySymbol:e.value.currency.symbol});if(console.log("Payment Intent API Response:",{status:s.status,data:s.data}),s.status===200||s.status===201){const k=s.data;if(console.log("Received UUID from Payment Intent API:",k),!k){console.error("No UUID received from Payment Intent API"),f.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")});return}const S=`/api/v1/challenge-code?uuid=${k}&src=email`;console.log("Calling Challenge Code API:",{url:S,headers:{Authorization:`Bearer ${E.value}`,"X-apikey":E.value}});const d=await G.get(S,{headers:{Authorization:`Bearer ${E.value}`,"X-apikey":E.value}});if(console.log("Challenge Code API Response:",{status:d.status,data:d.data}),d.status===200||d.status===201){if(!d.data){console.error("Empty response from Challenge Code API"),f.showNotification({type:"error",message:o("invoices.invalid_payment_link_response")});return}const j=d.data.url||null;if(!j){console.error("URL not found in Challenge Code API response:",d.data),f.showNotification({type:"error",message:o("invoices.invalid_payment_link_response")});return}const T=`${J.value}/${j.replace("null?","pay.ps?")}`;console.log("Generated Payment Link:",T);try{const g=await G.get("/api/v1/custom-fields",{params:{model_type:"Invoice",name:"PaymentLink"}});if(!g.data||!g.data.data||!g.data.data[0])throw new Error("PaymentLink custom field not found");const z={fields:[{id:g.data.data[0].id,name:"PaymentLink",value:T}]};console.log("Updating invoice with payment link:",{invoiceId:e.value.id,customFieldData:z});const O=await n.updateInvoice({id:e.value.id,invoice_date:e.value.invoice_date,customer_id:e.value.customer_id,invoice_number:e.value.invoice_number,discount:e.value.discount,discount_val:e.value.discount_val,sub_total:e.value.sub_total,total:e.value.total,tax:e.value.tax,template_name:e.value.template_name,items:e.value.items,customFields:z});console.log("Invoice Update Response:",{status:"success",data:O}),oe.copyTextToClipboard(T),f.showNotification({type:"success",message:o("invoices.payment_link_copied")}),console.log("Refreshing invoice data..."),await U(),console.log("Invoice data refreshed successfully")}catch(g){console.error("Failed to update invoice:",g),f.showNotification({type:"error",message:o("invoices.failed_to_update_payment_link")})}}else console.error("Challenge Code API failed:",{status:d.status,data:d.data}),f.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")})}else console.error("Payment Intent API failed:",{status:s.status,data:s.data}),f.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")})}catch(a){console.error("Error in onGeneratePaymentLink:",{error:a,message:a.message,response:a.response?{status:a.response.status,data:a.response.data}:null}),f.showNotification({type:"error",message:o("invoices.failed_to_generate_payment_link")})}})}function ue(t){return C.params.id==t}async function F(t,a=!1){if(N.value)return;let s={};i.searchText!==""&&i.searchText!==null&&i.searchText!==void 0&&(s.search=i.searchText),i.orderBy!==null&&i.orderBy!==void 0&&(s.orderBy=i.orderBy),i.orderByField!==null&&i.orderByField!==void 0&&(s.orderByField=i.orderByField),N.value=!0;let k=await n.fetchInvoices(K({page:t},s));N.value=!1,_.value=_.value?_.value:[],_.value=[..._.value,...k.data.data],D.value=t||1,H.value=k.data.meta.last_page;let S=_.value.find(d=>d.id==C.params.id);a==!1&&!S&&D.value<H.value&&Object.keys(s).length===0&&F(++D.value),S&&setTimeout(()=>{a==!1&&de()},500)}function de(){const t=document.getElementById(`invoice-${C.params.id}`);t&&(t.scrollIntoView({behavior:"smooth"}),t.classList.add("shake"),me())}function me(){W.value.addEventListener("scroll",t=>{t.target.scrollTop>0&&t.target.scrollTop+t.target.clientHeight>t.target.scrollHeight-200&&D.value<H.value&&F(++D.value,!0)})}async function U(){let t=await n.fetchInvoice(C.params.id);t.data&&(e.value=K({},t.data.data))}async function w(){_.value=[],F()}function pe(){return i.orderBy==="asc"?(i.orderBy="desc",w(),!0):(i.orderBy="asc",w(),!0)}function ve(){let t=_.value.findIndex(a=>a.id===e.value.id);_.value[t]&&(_.value[t].status="SENT",e.value.status="SENT")}return F(),U(),w=Pe.exports.debounce(w,500),(t,a)=>{const s=v("BaseButton"),k=v("router-link"),S=v("BasePageHeader"),d=v("BaseIcon"),j=v("BaseInput"),T=v("BaseRadio"),g=v("BaseInputGroup"),M=v("BaseDropdownItem"),z=v("BaseDropdown"),O=v("BaseText"),ye=v("BaseEstimateStatusBadge"),_e=v("BaseFormatMoney"),fe=v("BasePage");return p(),L(ae,null,[l(Ve,{onUpdate:ve}),e.value?(p(),h(fe,{key:0,class:"xl:pl-96 xl:ml-8"},{default:c(()=>{var Z;return[l(S,{title:u(ne)},{actions:c(()=>[y("div",ze,[e.value.status==="DRAFT"&&u(P).hasAbilities(u(R).EDIT_INVOICE)?(p(),h(s,{key:0,disabled:V.value,variant:"primary-outline",onClick:ie},{default:c(()=>[A(b(t.$t("invoices.mark_as_sent")),1)]),_:1},8,["disabled"])):x("",!0)]),e.value.status==="DRAFT"&&u(P).hasAbilities(u(R).SEND_INVOICE)?(p(),h(s,{key:0,variant:"primary",class:"text-sm mr-2",onClick:re},{default:c(()=>[A(b(t.$t("invoices.send_invoice")),1)]),_:1})):x("",!0),e.value.status==="DRAFT"&&u(P).hasAbilities(u(R).CREATE_PAYMENT)?(p(),h(s,{key:1,variant:"primary",class:"text-sm",onClick:le},{default:c(()=>[A(b(t.$t("invoices.pay_as_cash")),1)]),_:1})):x("",!0),e.value.status==="DRAFT"&&u(P).hasAbilities(u(R).CREATE_PAYMENT)?(p(),h(s,{key:2,variant:"primary",class:"text-sm ml-2",onClick:ce},{default:c(()=>[A(b(t.$t("invoices.generate_payment_link")),1)]),_:1})):x("",!0),u(P).hasAbilities(u(R).CREATE_PAYMENT)?(p(),h(k,{key:3,to:`/admin/payments/${t.$route.params.id}/create`},{default:c(()=>[e.value.status==="SENT"||e.value.status==="VIEWED"?(p(),h(s,{key:0,variant:"primary"},{default:c(()=>[A(b(t.$t("invoices.record_payment")),1)]),_:1})):x("",!0)]),_:1},8,["to"])):x("",!0),l(Ue,{class:"ml-3",row:e.value,"load-data":F},null,8,["row"])]),_:1},8,["title"]),y("div",Ge,[y("div",Ye,[y("div",He,[l(j,{modelValue:u(i).searchText,"onUpdate:modelValue":a[0]||(a[0]=r=>u(i).searchText=r),placeholder:t.$t("general.search"),type:"text",variant:"gray",onInput:a[1]||(a[1]=r=>w())},{right:c(()=>[l(d,{name:"SearchIcon",class:"h-5 text-gray-400"})]),_:1},8,["modelValue","placeholder"])]),y("div",Oe,[l(z,{class:"ml-3",position:"bottom-start"},{activator:c(()=>[l(s,{size:"md",variant:"gray"},{default:c(()=>[l(d,{name:"FilterIcon"})]),_:1})]),default:c(()=>[y("div",qe,b(t.$t("general.sort_by")),1),l(M,{class:"flex px-1 py-2 cursor-pointer"},{default:c(()=>[l(g,{class:"-mt-3 font-normal"},{default:c(()=>[l(T,{id:"filter_invoice_date",modelValue:u(i).orderByField,"onUpdate:modelValue":[a[2]||(a[2]=r=>u(i).orderByField=r),w],label:t.$t("reports.invoices.invoice_date"),size:"sm",name:"filter",value:"invoice_date"},null,8,["modelValue","label"])]),_:1})]),_:1}),l(M,{class:"flex px-1 py-2 cursor-pointer"},{default:c(()=>[l(g,{class:"-mt-3 font-normal"},{default:c(()=>[l(T,{id:"filter_due_date",modelValue:u(i).orderByField,"onUpdate:modelValue":[a[3]||(a[3]=r=>u(i).orderByField=r),w],label:t.$t("invoices.due_date"),value:"due_date",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1}),l(M,{class:"flex px-1 py-2 cursor-pointer"},{default:c(()=>[l(g,{class:"-mt-3 font-normal"},{default:c(()=>[l(T,{id:"filter_invoice_number",modelValue:u(i).orderByField,"onUpdate:modelValue":[a[4]||(a[4]=r=>u(i).orderByField=r),w],label:t.$t("invoices.invoice_number"),value:"invoice_number",size:"sm",name:"filter"},null,8,["modelValue","label"])]),_:1})]),_:1})]),_:1}),l(s,{class:"ml-1",size:"md",variant:"gray",onClick:pe},{default:c(()=>[u(Q)?(p(),h(d,{key:0,name:"SortAscendingIcon"})):(p(),h(d,{key:1,name:"SortDescendingIcon"}))]),_:1})])]),y("div",{ref:(r,q)=>{q.invoiceListSection=r,W.value=r},class:"h-full overflow-y-scroll border-l border-gray-200 border-solid base-scroll"},[(p(!0),L(ae,null,Se(_.value,(r,q)=>(p(),L("div",{key:q},[r?(p(),h(k,{key:0,id:"invoice-"+r.id,to:`/admin/invoices/${r.id}/view`,class:Te(["flex justify-between side-invoice p-4 cursor-pointer hover:bg-gray-100 items-center border-l-4 border-transparent",{"bg-gray-100 border-l-4 border-primary-500 border-solid":ue(r.id)}]),style:{"border-bottom":"1px solid rgba(185, 193, 209, 0.41)"}},{default:c(()=>[y("div",Ke,[l(O,{text:r.customer.name,length:30,class:"pr-2 mb-2 text-sm not-italic font-normal leading-5 text-black capitalize truncate"},null,8,["text"]),y("div",Xe,b(r.invoice_number),1),l(ye,{status:r.status,class:"px-1 text-xs"},{default:c(()=>[A(b(r.status),1)]),_:2},1032,["status"])]),y("div",Je,[l(_e,{class:"mb-2 text-xl not-italic font-semibold leading-8 text-right text-gray-900 block",amount:r.total,currency:r.customer.currency},null,8,["amount","currency"]),y("div",We,b(r.formatted_invoice_date),1)])]),_:2},1032,["id","to","class"])):x("",!0)]))),128)),N.value?(p(),L("div",Qe,[l(je,{class:"h-6 m-1 animate-spin text-primary-400"})])):x("",!0),!((Z=_.value)==null?void 0:Z.length)&&!N.value?(p(),L("p",Ze,b(t.$t("invoices.no_matching_invoices")),1)):x("",!0)],512)]),y("div",et,[y("iframe",{src:`${u(se)}`,class:"flex-1 border border-gray-400 border-solid bg-white rounded-md frame-style"},null,8,tt)])]}),_:1})):x("",!0)],64)}}};export{ut as default};
