var v=Object.defineProperty,S=Object.defineProperties;var x=Object.getOwnPropertyDescriptors;var _=Object.getOwnPropertySymbols;var w=Object.prototype.hasOwnProperty,M=Object.prototype.propertyIsEnumerable;var h=(a,t,n)=>t in a?v(a,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[t]=n,f=(a,t)=>{for(var n in t||(t={}))w.call(t,n)&&h(a,n,t[n]);if(_)for(var n of _(t))M.call(t,n)&&h(a,n,t[n]);return a},y=(a,t)=>S(a,x(t));import{a as d,o as u,e as m,h as e,t as c,j as p,q as l,b4 as g}from"./vendor.d9c52bb1.js";import{_ as k,b as C}from"./main.49e7919b.js";const I={name:"DatabaseSettings",setup(){return{companyStore:C()}},data(){return{databaseSettings:{database_connection_host:"",database_connection_port:"",database_connection_name:"",database_connection_username:"",database_connection_password:""},isTesting:!1,isSaving:!1,isMigrating:!1,error:null,success:null,migrationStatus:"Starting migrations...",canRunMigrations:!1}},created(){this.getSettings()},methods:{getCompanyId(){return this.companyStore&&this.companyStore.selectedCompany&&this.companyStore.selectedCompany.id?this.companyStore.selectedCompany.id:this.$route.params.companyId?this.$route.params.companyId:(console.error("No company ID available in context"),null)},async getSettings(){try{const a=this.getCompanyId();if(!a){console.error("No company ID available"),this.error="No company ID available. Please select a company first.";return}const t=await d.get(`/api/v1/settings/database?company_id=${a}`);console.log("... Database Settings from API /api/v1/settings/database: "+t.data),this.databaseSettings={database_connection_host:t.data.settings.database_host||"",database_connection_port:t.data.settings.database_port||"",database_connection_name:t.data.settings.database_name||"",database_connection_username:t.data.settings.database_username||"",database_connection_password:t.data.settings.database_password||""},this.canRunMigrations=!0}catch(a){this.error="Failed to load database settings",console.error("... Error loading settings:",a)}},async testConnection(){var a,t,n,r;this.isTesting=!0,this.error=null,this.success=null;try{const s=this.getCompanyId();if(!s){console.error("No company ID available"),this.error="No company ID available. Please select a company first.";return}const i={company_id:s,database_host:this.databaseSettings.database_connection_host,database_port:this.databaseSettings.database_connection_port,database_name:this.databaseSettings.database_connection_name,database_username:this.databaseSettings.database_connection_username,database_password:this.databaseSettings.database_connection_password},o=await d.post("/api/v1/settings/database/test",i);console.log("Connection test response:",o.data),this.success="Connection successful!"}catch(s){console.error("Connection test failed:",{status:(a=s.response)==null?void 0:a.status,data:(t=s.response)==null?void 0:t.data,message:s.message}),this.error=((r=(n=s.response)==null?void 0:n.data)==null?void 0:r.message)||"Failed to connect to database"}finally{this.isTesting=!1}},async saveSettings(){var a,t,n,r;this.isSaving=!0,this.error=null,this.success=null;try{const s=this.getCompanyId();if(!s){console.error("No company ID available"),this.error="No company ID available. Please select a company first.";return}const i={company_id:s,database_host:this.databaseSettings.database_connection_host,database_port:this.databaseSettings.database_connection_port,database_name:this.databaseSettings.database_connection_name,database_username:this.databaseSettings.database_connection_username,database_password:this.databaseSettings.database_connection_password};console.log("Saving settings:",y(f({},i),{database_password:"***"}));const o=await d.post("/api/v1/settings/database",i);console.log("... Save settings response:",o.data),this.success="Settings saved successfully!",this.canRunMigrations=!0}catch(s){console.error("Save settings failed:",{status:(a=s.response)==null?void 0:a.status,data:(t=s.response)==null?void 0:t.data,message:s.message}),this.error=((r=(n=s.response)==null?void 0:n.data)==null?void 0:r.message)||"Failed to save settings"}finally{this.isSaving=!1}},async runMigrations(){var a,t,n,r,s;this.isMigrating=!0,this.error=null,this.success=null,this.migrationStatus="Starting migrations...";try{const i=this.getCompanyId();if(!i){console.error("No company ID available"),this.error="No company ID available. Please select a company first.";return}if(this.migrationStatus="Checking migration status...",(await d.get(`/api/v1/settings/database/check-migrations?company_id=${i}`)).data.migrations_completed){this.error="Migrations have already been run. Running them again may cause data duplication.",this.migrationStatus="Migrations already completed";return}this.migrationStatus="Creating database...",await new Promise(b=>setTimeout(b,1e3)),this.migrationStatus="Running migrations...";const et=await d.post("/api/v1/settings/database/migrate",{company_id:i});this.migrationStatus="Setting up company defaults...",await new Promise(b=>setTimeout(b,1e3)),this.success="Migrations completed successfully!",this.migrationStatus="Migrations completed!"}catch(i){((n=(t=(a=i.response)==null?void 0:a.data)==null?void 0:t.message)==null?void 0:n.includes("Duplicate entry"))?(this.error="Migrations have already been run. Running them again may cause data duplication.",this.migrationStatus="Migrations already completed"):(this.error=((s=(r=i.response)==null?void 0:r.data)==null?void 0:s.message)||"Failed to run migrations",this.migrationStatus="Migration failed"),console.error("Migration failed:",i)}finally{setTimeout(()=>{this.isMigrating=!1},2e3)}}}},D={class:"flex flex-col"},T={class:"flex flex-col"},N={class:"flex items-center justify-between mb-6"},P=e("h1",{class:"text-2xl font-bold text-gray-900"},"Database Settings",-1),R={class:"flex items-center space-x-4"},V=["disabled"],U=["disabled"],j=["disabled"],F={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"},B={class:"p-6 bg-white rounded-lg shadow-xl"},E={class:"flex items-center space-x-4"},q=e("div",{class:"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"},null,-1),z={class:"text-lg font-medium text-gray-900"},A=e("div",{class:"mt-4 text-sm text-gray-500"}," This may take a few minutes. Please do not close this window. ",-1),H={class:"grid grid-cols-1 gap-6 mt-6 sm:grid-cols-2"},G={class:"space-y-4"},J=e("label",{class:"block text-sm font-medium text-gray-700"},"Host",-1),K=e("label",{class:"block text-sm font-medium text-gray-700"},"Port",-1),L=e("label",{class:"block text-sm font-medium text-gray-700"},"Database Name",-1),O={class:"space-y-4"},Q=e("label",{class:"block text-sm font-medium text-gray-700"},"Username",-1),W=e("label",{class:"block text-sm font-medium text-gray-700"},"Password",-1),X=e("div",{class:"mt-6"},[e("div",{class:"p-4 text-sm text-blue-700 bg-blue-100 rounded-md"},' Please enter your database connection details and click "Test Connection" to verify before saving. ')],-1),Y={key:1,class:"mt-4"},Z={class:"p-4 text-sm text-red-700 bg-red-100 rounded-md"},$={key:2,class:"mt-4"},tt={class:"p-4 text-sm text-green-700 bg-green-100 rounded-md"};function st(a,t,n,r,s,i){return u(),m("div",D,[e("div",T,[e("div",N,[P,e("div",R,[e("button",{onClick:t[0]||(t[0]=(...o)=>i.testConnection&&i.testConnection(...o)),class:"px-4 py-2 text-sm font-medium text-white bg-yellow-500 rounded-md hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500",disabled:s.isTesting||s.isMigrating},c(s.isTesting?"Testing Connection...":"Test Connection"),9,V),e("button",{onClick:t[1]||(t[1]=(...o)=>i.saveSettings&&i.saveSettings(...o)),class:"px-4 py-2 text-sm font-medium text-white bg-blue-500 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500",disabled:s.isSaving||s.isMigrating},c(s.isSaving?"Saving...":"Save Settings"),9,U),e("button",{onClick:t[2]||(t[2]=(...o)=>i.runMigrations&&i.runMigrations(...o)),class:"px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500",disabled:s.isMigrating||!s.canRunMigrations},c(s.isMigrating?"Running Migrations...":"Run Migrations"),9,j)])]),s.isMigrating?(u(),m("div",F,[e("div",B,[e("div",E,[q,e("div",z,c(s.migrationStatus),1)]),A])])):p("",!0),e("div",H,[e("div",G,[e("div",null,[J,l(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>s.databaseSettings.database_connection_host=o),type:"text",class:"block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"},null,512),[[g,s.databaseSettings.database_connection_host]])]),e("div",null,[K,l(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>s.databaseSettings.database_connection_port=o),type:"text",class:"block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"},null,512),[[g,s.databaseSettings.database_connection_port]])]),e("div",null,[L,l(e("input",{"onUpdate:modelValue":t[5]||(t[5]=o=>s.databaseSettings.database_connection_name=o),type:"text",class:"block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"},null,512),[[g,s.databaseSettings.database_connection_name]])])]),e("div",O,[e("div",null,[Q,l(e("input",{"onUpdate:modelValue":t[6]||(t[6]=o=>s.databaseSettings.database_connection_username=o),type:"text",class:"block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"},null,512),[[g,s.databaseSettings.database_connection_username]])]),e("div",null,[W,l(e("input",{"onUpdate:modelValue":t[7]||(t[7]=o=>s.databaseSettings.database_connection_password=o),type:"password",class:"block w-full mt-1 border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"},null,512),[[g,s.databaseSettings.database_connection_password]])])])]),X,s.error?(u(),m("div",Y,[e("div",Z,c(s.error),1)])):p("",!0),s.success?(u(),m("div",$,[e("div",tt,c(s.success),1)])):p("",!0)])])}var it=k(I,[["render",st]]);export{it as default};
